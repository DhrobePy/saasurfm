<?php
require_once '../../core/init.php';

$allowed_roles = ['Superadmin', 'admin', 'Transport Manager'];
restrict_access($allowed_roles);

global $db;
$pageTitle = 'Log Maintenance';

// Get vehicle_id if passed
$vehicle_id_param = $_GET['vehicle_id'] ?? null;

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        $db->getPdo()->beginTransaction();
        
        $vehicle_id = (int)$_POST['vehicle_id'];
        $parts_cost = floatval($_POST['parts_cost'] ?? 0);
        $labor_cost = floatval($_POST['labor_cost'] ?? 0);
        $total_cost = $parts_cost + $labor_cost;
        
        // Insert maintenance log
        $maintenance_data = [
            'vehicle_id' => $vehicle_id,
            'maintenance_type' => $_POST['maintenance_type'],
            'maintenance_date' => $_POST['maintenance_date'],
            'service_provider' => trim($_POST['service_provider']) ?: null,
            'description' => trim($_POST['description']) ?: null,
            'odometer_reading' => floatval($_POST['odometer_reading'] ?? 0),
            'parts_cost' => $parts_cost,
            'labor_cost' => $labor_cost,
            'total_cost' => $total_cost,
            'invoice_number' => trim($_POST['invoice_number']) ?: null,
            'warranty_expiry_date' => $_POST['warranty_expiry_date'] ?: null,
            'next_service_due_date' => $_POST['next_service_due_date'] ?: null,
            'next_service_due_mileage' => floatval($_POST['next_service_due_mileage'] ?? 0),
            'status' => 'Completed',
            'payment_status' => $_POST['payment_status'],
            'notes' => trim($_POST['notes']) ?: null,
            'created_by_user_id' => $_SESSION['user_id']
        ];
        
        $maintenance_log_id = $db->insert('maintenance_logs', $maintenance_data);
        
        // Update vehicle details
        $updates = [];
        $update_params = [];
        
        if ($maintenance_data['odometer_reading'] > 0) {
            $updates[] = "current_mileage = ?";
            $update_params[] = $maintenance_data['odometer_reading'];
        }
        
        $updates[] = "last_service_date = ?";
        $update_params[] = $maintenance_data['maintenance_date'];
        
        if ($maintenance_data['next_service_due_date']) {
            $updates[] = "next_service_due_date = ?";
            $update_params[] = $maintenance_data['next_service_due_date'];
        }
        
        if ($maintenance_data['next_service_due_mileage'] > 0) {
            $updates[] = "next_service_due_mileage = ?";
            $update_params[] = $maintenance_data['next_service_due_mileage'];
        }
        
        $update_params[] = $vehicle_id;
        
        if (!empty($updates)) {
            $db->query(
                "UPDATE vehicles SET " . implode(', ', $updates) . " WHERE id = ?",
                $update_params
            );
        }
        
        // Create accounting entry
        $journal_entry_id = $db->insert('journal_entries', [
            'entry_date' => $_POST['maintenance_date'],
            'entry_type' => 'Expense',
            'reference_type' => 'Maintenance',
            'reference_id' => $maintenance_log_id,
            'description' => "Maintenance for vehicle ID: $vehicle_id - {$maintenance_data['maintenance_type']}",
            'created_by_user_id' => $_SESSION['user_id']
        ]);
        
        // Get maintenance expense account (5020)
        $maintenance_account = $db->query("SELECT id FROM chart_of_accounts WHERE account_code = '5020'")->first();
        $maintenance_account_id = $maintenance_account ? $maintenance_account->id : 5020;
        
        // Get cash/bank account
        $payment_method = $_POST['payment_method'] ?? 'Cash';
        $cash_account_id = ($payment_method === 'Cash') ? 1010 : 1020;
        
        // Debit: Maintenance Expense
        $db->insert('journal_entry_lines', [
            'journal_entry_id' => $journal_entry_id,
            'account_id' => $maintenance_account_id,
            'debit' => $total_cost,
            'credit' => 0
        ]);
        
        // Credit: Cash/Bank
        $db->insert('journal_entry_lines', [
            'journal_entry_id' => $journal_entry_id,
            'account_id' => $cash_account_id,
            'debit' => 0,
            'credit' => $total_cost
        ]);
        
        // Link journal entry
        $db->query(
            "UPDATE maintenance_logs SET journal_entry_id = ? WHERE id = ?",
            [$journal_entry_id, $maintenance_log_id]
        );
        
        $db->getPdo()->commit();
        
        $_SESSION['success_flash'] = "Maintenance logged successfully! Cost: à§³" . number_format($total_cost, 2);
        header('Location: index.php');
        exit();
        
    } catch (Exception $e) {
        if ($db->getPdo()->inTransaction()) {
            $db->getPdo()->rollBack();
        }
        $_SESSION['error_flash'] = 'Error: ' . $e->getMessage();
    }
}

// Get vehicles
$vehicles = $db->query(
    "SELECT id, vehicle_number, current_mileage 
     FROM vehicles 
     WHERE status IN ('Active', 'Maintenance')
     ORDER BY vehicle_number"
)->results();

require_once '../../templates/header.php';
?>

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

<div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h1 class="text-2xl font-bold text-gray-900">ðŸ”§ Log Maintenance</h1>
        <a href="index.php" class="px-4 py-2 border rounded-lg hover:bg-gray-50">
            <i class="fas fa-arrow-left mr-2"></i>Back
        </a>
    </div>

    <form method="POST" class="space-y-6">
        
        <!-- Vehicle Selection -->
        <div>
            <h3 class="text-lg font-medium text-gray-900 mb-4">Vehicle Information</h3>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Vehicle *</label>
                <select name="vehicle_id" id="vehicle_id" required class="w-full px-4 py-2 border rounded-lg">
                    <option value="">-- Select Vehicle --</option>
                    <?php foreach ($vehicles as $vehicle): ?>
                    <option value="<?php echo $vehicle->id; ?>" 
                            data-mileage="<?php echo $vehicle->current_mileage; ?>"
                            <?php echo ($vehicle_id_param == $vehicle->id) ? 'selected' : ''; ?>>
                        <?php echo htmlspecialchars($vehicle->vehicle_number); ?> 
                        (<?php echo number_format($vehicle->current_mileage, 0); ?> km)
                    </option>
                    <?php endforeach; ?>
                </select>
            </div>
        </div>
        
        <!-- Maintenance Details -->
        <div>
            <h3 class="text-lg font-medium text-gray-900 mb-4">Maintenance Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Maintenance Type *</label>
                    <select name="maintenance_type" required class="w-full px-4 py-2 border rounded-lg">
                        <option value="">-- Select Type --</option>
                        <option value="Routine Service">Routine Service</option>
                        <option value="Repair">Repair</option>
                        <option value="Oil Change">Oil Change</option>
                        <option value="Tire Change">Tire Change</option>
                        <option value="Battery">Battery Replacement</option>
                        <option value="Brake Service">Brake Service</option>
                        <option value="Engine">Engine Work</option>
                        <option value="Transmission">Transmission</option>
                        <option value="Electrical">Electrical</option>
                        <option value="Body Work">Body Work</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Maintenance Date *</label>
                    <input type="date" name="maintenance_date" required
                           class="w-full px-4 py-2 border rounded-lg"
                           value="<?php echo date('Y-m-d'); ?>"
                           max="<?php echo date('Y-m-d'); ?>">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Service Provider</label>
                    <input type="text" name="service_provider"
                           class="w-full px-4 py-2 border rounded-lg"
                           placeholder="e.g., ABC Auto Workshop">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Odometer Reading (km)</label>
                    <input type="number" step="0.01" name="odometer_reading" id="odometer_reading"
                           class="w-full px-4 py-2 border rounded-lg"
                           placeholder="15000">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" rows="3" class="w-full px-4 py-2 border rounded-lg"
                              placeholder="Describe the maintenance work performed..."></textarea>
                </div>
            </div>
        </div>
        
        <!-- Cost Details -->
        <div>
            <h3 class="text-lg font-medium text-gray-900 mb-4">Cost Breakdown</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Parts Cost (BDT)</label>
                    <input type="number" step="0.01" name="parts_cost" id="parts_cost"
                           class="w-full px-4 py-2 border rounded-lg"
                           placeholder="2000.00"
                           value="0.00"
                           oninput="calculateTotal()">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Labor Cost (BDT)</label>
                    <input type="number" step="0.01" name="labor_cost" id="labor_cost"
                           class="w-full px-4 py-2 border rounded-lg"
                           placeholder="1000.00"
                           value="0.00"
                           oninput="calculateTotal()">
                </div>
                
                <div class="md:col-span-2">
                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total Cost</label>
                        <p class="text-3xl font-bold text-orange-600" id="total_cost_display">à§³0.00</p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                    <input type="text" name="invoice_number"
                           class="w-full px-4 py-2 border rounded-lg"
                           placeholder="INV-12345">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status *</label>
                    <select name="payment_status" required class="w-full px-4 py-2 border rounded-lg">
                        <option value="Paid">Paid</option>
                        <option value="Pending">Pending</option>
                        <option value="Partial">Partial</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                    <select name="payment_method" class="w-full px-4 py-2 border rounded-lg">
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Card">Card</option>
                        <option value="Check">Check</option>
                        <option value="Account">Account</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Warranty Expiry Date</label>
                    <input type="date" name="warranty_expiry_date"
                           class="w-full px-4 py-2 border rounded-lg"
                           min="<?php echo date('Y-m-d'); ?>">
                </div>
            </div>
        </div>
        
        <!-- Next Service -->
        <div>
            <h3 class="text-lg font-medium text-gray-900 mb-4">Next Service Schedule</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Next Service Due Date</label>
                    <input type="date" name="next_service_due_date"
                           class="w-full px-4 py-2 border rounded-lg"
                           min="<?php echo date('Y-m-d'); ?>">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Next Service Due Mileage (km)</label>
                    <input type="number" step="0.01" name="next_service_due_mileage"
                           class="w-full px-4 py-2 border rounded-lg"
                           placeholder="20000">
                </div>
            </div>
        </div>
        
        <!-- Notes -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
            <textarea name="notes" rows="3" class="w-full px-4 py-2 border rounded-lg"
                      placeholder="Any additional information..."></textarea>
        </div>
        
        <!-- Submit -->
        <div class="flex justify-end gap-3 pt-6 border-t">
            <a href="index.php" class="px-6 py-2 border rounded-lg hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                <i class="fas fa-save mr-2"></i>Log Maintenance
            </button>
        </div>
    </form>
</div>

</div>

<script>
// Auto-fill odometer from vehicle
document.getElementById('vehicle_id').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (this.value) {
        const mileage = selectedOption.dataset.mileage;
        document.getElementById('odometer_reading').value = mileage;
    }
});

// Calculate total cost
function calculateTotal() {
    const parts = parseFloat(document.getElementById('parts_cost').value) || 0;
    const labor = parseFloat(document.getElementById('labor_cost').value) || 0;
    const total = parts + labor;
    
    document.getElementById('total_cost_display').textContent = 'à§³' + total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Initialize total
calculateTotal();
</script>

<?php require_once '../../templates/footer.php'; ?>